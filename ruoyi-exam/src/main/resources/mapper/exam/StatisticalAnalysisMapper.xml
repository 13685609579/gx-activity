<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.exam.mapper.StatisticalAnalysisMapper">

    <resultMap type="CandidateClassHourVo" id="CandidateClassHourVoResult">
        <result property="unitId"       column="unit_id"      />
        <result property="unitName"       column="unit_name"      />
        <result property="examYear"        column="exam_year"        />
        <result property="candidateId"     column="candidate_id"    />
        <result property="classHour"     column="class_hour"    />
    </resultMap>

    <select id="selectStatisticalAnalysisList" parameterType="com.ruoyi.exam.domain.vo.CandidateClassHourVo" resultMap="CandidateClassHourVoResult">
        select tbl5.candidate_id, tbl5.unit_id, tbl5.unit_name, tbl5.exam_year,
        case when class_hour is null then '0' else class_hour end class_hour FROM
        (
        select distinct tbl2.candidate_id, tbl1.dept_id as unit_id, tbl1.dept_name as unit_name, tbl4.exam_id, tbl4.exam_year
        from sys_dept tbl1 LEFT JOIN candidate_info tbl2 ON tbl1.dept_id = tbl2.unit_id
        LEFT JOIN candidate_sign_up tbl3 ON tbl2.candidate_id = tbl3.candidate_id and tbl2.unit_id = tbl3.unit_id
        LEFT JOIN exam_manage tbl4 ON tbl3.exam_id = tbl4.exam_id
        where tbl1.del_flag = 0
        and tbl2.del_flag = 0
        and tbl3.del_flag = 0
        and tbl4.del_flag = 0
        and tbl4.publish_state = 1
        <if test="examYear != null and examYear != ''">
            AND tbl4.exam_year = #{examYear}
        </if>
        <if test="unitName != null and unitName != ''">
            AND tbl1.dept_name like concat('%', #{unitName}, '%')
        </if>
        <if test="unitIds != null">
            AND tbl1.dept_id in
            <foreach collection="unitIds" item="unitId" open="(" separator="," close=")">
                #{unitId}
            </foreach>
        </if>
        ) tbl5 LEFT JOIN
        (
        select candidate_id, exam_id, case when sum(class_hour) is null then '0' else sum(class_hour) end class_hour from person_class_hour
        where del_flag = 0
        GROUP BY candidate_id, exam_id
        )
        tbl6 ON tbl5.candidate_id = tbl6.candidate_id AND tbl5.exam_id = tbl6.exam_id
        GROUP BY tbl5.candidate_id, tbl5.unit_id, tbl5.unit_name, tbl5.exam_year
        <!-- 数据范围过滤 -->
        ${params.dataScope}
    </select>

    <resultMap type="StatisticalAnalysisDetailsVo" id="StatisticalAnalysisDetailsResult">
        <result property="candidateId"       column="candidate_id"      />
        <result property="candidateName"       column="candidate_name"      />
        <result property="unitName"       column="unit_name"      />
        <result property="mobile"       column="mobile"      />
        <result property="examYear"        column="exam_year"        />
    </resultMap>

    <select id="getStatisticalAnalysisDetails" parameterType="com.ruoyi.exam.domain.vo.StatisticalAnalysisDetailsVo" resultMap="StatisticalAnalysisDetailsResult">
        select DISTINCT tbl2.candidate_id, tbl2.candidate_name, tbl1.dept_name as unit_name, tbl2.mobile, tbl4.exam_year
        from sys_dept tbl1 LEFT JOIN candidate_info tbl2 ON tbl1.dept_id = tbl2.unit_id
        LEFT JOIN candidate_sign_up tbl3 ON tbl2.candidate_id = tbl3.candidate_id AND tbl2.unit_id = tbl3.unit_id
        LEFT JOIN exam_manage tbl4 ON tbl3.exam_id = tbl4.exam_id
        where tbl1.del_flag = 0
        and tbl2.del_flag = 0
        and tbl3.del_flag = 0
        and tbl4.del_flag = 0
        <if test="unitId != null and unitId != ''">
            AND tbl1.dept_id = #{unitId}
        </if>
        <if test="candidateName != null and candidateName != ''">
            AND tbl2.candidate_name = #{candidateName}
        </if>
        <if test="mobile != null and mobile != ''">
            AND tbl2.mobile = #{mobile}
        </if>
        <if test="examYear != null and examYear != ''">
            AND tbl4.exam_year = #{examYear}
        </if>
        <!-- 数据范围过滤 -->
        ${params.dataScope}
    </select>

</mapper>
