<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.exam.mapper.QuestionBankManageMapper">

    <resultMap type="QuestionBankManage" id="QuestionBankManageResult">
        <id     property="topicId"       column="topic_id"      />
        <result property="topicNum"       column="topic_num"      />
        <result property="topicCode"     column="topic_code"    />
        <result property="topicContent"     column="topic_content"    />
        <result property="topicSort"        column="topic_sort"        />
        <result property="topicType"  column="topic_type"  />
        <result property="topicOptions"  column="topic_options"  />
        <result property="topicAnswer"       column="topic_answer"       />
        <result property="answerAnalysis"       column="answer_analysis"       />
        <result property="perScore"     column="per_score"     />
        <result property="delFlag"      column="del_flag"     />
        <result property="createBy"     column="create_by"    />
        <result property="createTime"   column="create_time"  />
        <result property="updateBy"     column="update_by"    />
        <result property="updateTime"   column="update_time"  />
        <result property="remark"       column="remark"       />
    </resultMap>

    <select id="selectQuestionBankList" parameterType="com.ruoyi.exam.domain.QuestionBankManage" resultMap="QuestionBankManageResult">
        SELECT topic_id, topic_num, topic_code, topic_content, topic_sort, topic_type,
        case when topic_type = '3' then '正确、错误' else '' end topic_options,
        topic_answer, answer_analysis,
        per_score, del_flag, create_time, update_time, create_by, update_by, remark FROM question_bank_manage
        where del_flag = 0
        <if test="topicSort != null and topicSort != ''">
            AND topic_sort = #{topicSort}
        </if>
        <if test="topicType != null and topicType != ''">
            AND topic_type = #{topicType}
        </if>
        <if test="topicContent != null and topicContent != ''">
            AND topic_content like concat('%', #{topicContent}, '%')
        </if>
        order by create_time desc
        <!-- 数据范围过滤 -->
        ${params.dataScope}
    </select>

    <select id="selectCandidatePaper" parameterType="com.ruoyi.exam.domain.QuestionBankManage" resultMap="QuestionBankManageResult">
        select ROW_NUMBER() OVER (ORDER BY tbl.create_time) AS topic_num, tbl.topic_id, tbl.topic_code, tbl.topic_content, tbl.topic_sort,
        tbl.topic_type, tbl.topic_answer, tbl.answer_analysis, tbl.per_score, tbl.del_flag, tbl.create_time, tbl.update_time, tbl.create_by,
        tbl.update_by, tbl.remark from
        (
        (
        select tbl.topic_id, tbl.topic_code, tbl.topic_content, tbl.topic_sort, tbl.topic_type, tbl.topic_answer, tbl.answer_analysis,
        tbl.per_score, tbl.del_flag, tbl.create_time, tbl.update_time, tbl.create_by, tbl.update_by, tbl.remark from
        (
        SELECT topic_id, topic_code, topic_content, topic_sort, topic_type, topic_answer, answer_analysis,
        per_score, del_flag, create_time, update_time, create_by, update_by, remark FROM question_bank_manage
        where del_flag = 0
        <if test="topicSort != null and topicSort != ''">
            AND topic_sort = #{topicSort}
        </if>
        and topic_type = 1
        ) tbl
        order by RAND()
        limit 30
        )
        UNION ALL
        (
        select tbl.topic_id, tbl.topic_code, tbl.topic_content, tbl.topic_sort, tbl.topic_type, tbl.topic_answer, tbl.answer_analysis,
        tbl.per_score, tbl.del_flag, tbl.create_time, tbl.update_time, tbl.create_by, tbl.update_by, tbl.remark from
        (
        SELECT topic_id, topic_code, topic_content, topic_sort, topic_type, topic_answer, answer_analysis,
        per_score, del_flag, create_time, update_time, create_by, update_by, remark FROM question_bank_manage
        where del_flag = 0
        <if test="topicSort != null and topicSort != ''">
            AND topic_sort = #{topicSort}
        </if>
        and topic_type = 2
        ) tbl
        order by RAND()
        limit 4
        )
        UNION ALL
        (
        select tbl.topic_id, tbl.topic_code, tbl.topic_content, tbl.topic_sort, tbl.topic_type, tbl.topic_answer, tbl.answer_analysis,
        tbl.per_score, tbl.del_flag, tbl.create_time, tbl.update_time, tbl.create_by, tbl.update_by, tbl.remark from
        (
        SELECT topic_id, topic_code, topic_content, topic_sort, topic_type, topic_answer, answer_analysis,
        per_score, del_flag, create_time, update_time, create_by, update_by, remark FROM question_bank_manage
        where del_flag = 0
        <if test="topicSort != null and topicSort != ''">
            AND topic_sort = #{topicSort}
        </if>
        and topic_type = 3
        ) tbl
        order by RAND()
        limit 10
        )
        ) tbl
        ORDER BY
        CASE tbl.topic_type WHEN 1 THEN 1
        WHEN 2 THEN 2
        WHEN 3 THEN 3
        END
    </select>

    <select id="selectNewTopicCode" parameterType="String" resultType="String">
        select topic_code from question_bank_manage where del_flag = 0 and create_time >= #{today} order by create_time desc limit 1
    </select>

    <select id="selectMaxTopicNum" resultType="String">
        select max(topic_num) max_topic_num FROM question_bank_manage where del_flag = 0
    </select>

    <select id="selectNewQuestionBank" resultMap="QuestionBankManageResult">
        SELECT topic_id, topic_num, topic_code, topic_content, topic_sort, topic_type, topic_answer, answer_analysis,
        per_score, del_flag, create_time, update_time, create_by, update_by, remark FROM question_bank_manage
        where del_flag = 0
        order by create_time desc
        limit 1
    </select>

    <insert id="insertQuestionBankData" parameterType="com.ruoyi.exam.domain.QuestionBankManage">
        insert into question_bank_manage(
        <if test="topicId != null">topic_id,</if>
        <if test="topicNum != null">topic_num,</if>
        <if test="topicCode != null and topicCode != ''">topic_code,</if>
        <if test="topicContent != null and topicContent != ''">topic_content,</if>
        <if test="topicSort != null and topicSort != ''">topic_sort,</if>
        <if test="topicType != null and topicType != ''">topic_type,</if>
        <if test="topicAnswer != null and topicAnswer != ''">topic_answer,</if>
        <if test="answerAnalysis != null and answerAnalysis != ''">answer_analysis,</if>
        <if test="perScore != null">per_score,</if>
        del_flag,
        <if test="remark != null and remark != ''">remark,</if>
        <if test="createBy != null and createBy != ''">create_by,</if>
        create_time
        )values(
        <if test="topicId != null">#{topicId},</if>
        <if test="topicNum != null">#{topicNum},</if>
        <if test="topicCode != null and topicCode != ''">#{topicCode},</if>
        <if test="topicContent != null and topicContent != ''">#{topicContent},</if>
        <if test="topicSort != null and topicSort != ''">#{topicSort},</if>
        <if test="topicType != null and topicType != ''">#{topicType},</if>
        <if test="topicAnswer != null and topicAnswer != ''">#{topicAnswer},</if>
        <if test="answerAnalysis != null and answerAnalysis != ''">#{answerAnalysis},</if>
        <if test="perScore != null">#{perScore},</if>
        0,
        <if test="remark != null and remark != ''">#{remark},</if>
        <if test="createBy != null and createBy != ''">#{createBy},</if>
        sysdate()
        )
    </insert>

    <select id="questionBankInfo" parameterType="String" resultMap="QuestionBankManageResult">
        SELECT topic_id, topic_num, topic_code, topic_content, topic_sort, topic_type, topic_answer, answer_analysis,
        per_score, del_flag, create_time, update_time, create_by, update_by, remark FROM question_bank_manage
        where del_flag = 0
        <if test="topicId != null and topicId != ''">
            AND topic_id = #{topicId}
        </if>
    </select>

    <update id="updateQuestionBank" parameterType="com.ruoyi.exam.domain.QuestionBankManage">
        update question_bank_manage
        <set>
            <if test="topicContent != null and topicContent != ''">topic_content = #{topicContent},</if>
            <if test="topicAnswer != null and topicAnswer != ''">topic_answer = #{topicAnswer},</if>
            <if test="answerAnalysis != null and answerAnalysis != ''">answer_analysis = #{answerAnalysis},</if>
            <if test="delFlag != null and delFlag != ''">del_flag = #{delFlag},</if>
            update_time = sysdate()
        </set>
        where topic_id = #{topicId}
    </update>

    <select id="getSortFirst" parameterType="com.ruoyi.exam.domain.QuestionBankManage" resultMap="QuestionBankManageResult">
        SELECT topic_id, topic_num, topic_code, topic_content, topic_sort, topic_type, topic_answer, answer_analysis,
        per_score, del_flag, create_time, update_time, create_by, update_by, remark FROM question_bank_manage
        where del_flag = 0
        <if test="topicSort != null and topicSort != ''">
            AND topic_sort = #{topicSort}
        </if>
        ORDER BY topic_num limit 1
    </select>

    <select id="nextTestTopic" parameterType="com.ruoyi.exam.domain.QuestionBankManage" resultMap="QuestionBankManageResult">
        SELECT topic_id, topic_num, topic_code, topic_content, topic_sort, topic_type, topic_answer, answer_analysis,
        per_score, del_flag, create_time, update_time, create_by, update_by, remark FROM question_bank_manage
        where del_flag = 0
        <if test="topicSort != null and topicSort != ''">
            AND topic_sort = #{topicSort}
        </if>
        <if test="topicNum != null and topicNum != ''">
            AND topic_num > #{topicNum}
        </if>
        ORDER BY topic_num asc limit 1
    </select>

</mapper>
